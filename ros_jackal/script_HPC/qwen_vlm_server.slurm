#!/bin/bash
# ============================================================
# Hopper é›†ç¾¤ SLURM è„šæœ¬ - Qwen VLM æ¨ç†æœåŠ¡
# ============================================================
# ä½¿ç”¨åœºæ™¯ï¼š
#   - é€šè¿‡ SLURM åœ¨ Hopper GPU èŠ‚ç‚¹ä¸Šè¿è¡Œ
#   - æ­£å¼è®­ç»ƒå’Œå¤§è§„æ¨¡è¯„ä¼°
#
# æäº¤æ–¹å¼ï¼š
#   bash script_HPC/submit_single_qwen.sh DWA
#   bash script_HPC/submit_all_qwen.sh
#
# å¦‚æœè¦åœ¨æœ¬åœ°è°ƒè¯•ï¼Œè¯·ä½¿ç”¨ï¼š
#   bash script_HPC/start_qwen_dynamic.sh
# ============================================================

#SBATCH --partition=gpuq
#SBATCH --qos=gpu
#SBATCH --job-name=qwen_dynamic
#SBATCH --output=cpu_report/qwen_dynamic-%j.out
#SBATCH --error=cpu_report/qwen_dynamic-%j.err
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --gres=gpu:3g.40gb:1
#SBATCH --mem=40G
#SBATCH --export=ALL
#SBATCH --cpus-per-task=8
#SBATCH --time=4-23:59:00

echo "=================================================="
echo "Qwen Dynamic Checkpoint Service"
echo "=================================================="
echo "SLURM Job ID: $SLURM_JOB_ID"
echo "Running on node: $(hostname)"
echo "Node IP: $(hostname -I | awk '{print $1}')"
echo "GPU: $CUDA_VISIBLE_DEVICES"
echo ""
echo "Configuration:"
echo "  Initial Checkpoint: ${INITIAL_CHECKPOINT:-NOT_SET}"
echo "  Algorithm: ${ALGORITHM:-NOT_SET}"
echo "  Num Params: ${NUM_PARAMS:-NOT_SET}"
echo "  Port: ${PORT:-5000}"
echo "=================================================="
echo ""
echo "ğŸ”” IMPORTANT: Copy this for robot test:"
echo "   QWEN_HOST=\"$(hostname)\""
echo ""
echo "ğŸ“¡ API Endpoints:"
echo "   Health:  http://$(hostname):${PORT:-5000}/health"
echo "   Infer:   http://$(hostname):${PORT:-5000}/infer"
echo "   Switch:  http://$(hostname):${PORT:-5000}/switch_checkpoint"
echo "   List:    http://$(hostname):${PORT:-5000}/list_checkpoints"
echo "=================================================="

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p cpu_report

# æ¿€æ´» Python 3.10 Conda ç¯å¢ƒ
source /home/ylu22/miniforge/etc/profile.d/conda.sh
conda activate lmms-finetune-qwen

# æ‰“å°ç¯å¢ƒä¿¡æ¯
echo ""
echo "Python version: $(python --version)"
echo "PyTorch version: $(python -c 'import torch; print(torch.__version__)')"
echo "CUDA available: $(python -c 'import torch; print(torch.cuda.is_available())')"
echo ""

# åˆ‡æ¢åˆ°è„šæœ¬ç›®å½•
SCRIPT_DIR="/scratch/ylu22/appvlm_ws/src/ros_jackal/script_HPC"
cd ${SCRIPT_DIR}

# è®¾ç½® Python å®Œæ•´è·¯å¾„ï¼ˆç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ conda ç¯å¢ƒï¼‰
CONDA_PYTHON="/home/ylu22/miniforge/envs/lmms-finetune-qwen/bin/python"

# è®¾ç½®é»˜è®¤å€¼
BASE_MODEL="${BASE_MODEL:-Qwen/Qwen2.5-VL-7B-Instruct}"
HEAD_TYPE="${HEAD_TYPE:-dpt}"
PORT="${PORT:-5000}"

# éªŒè¯å¿…éœ€å‚æ•°ï¼ˆè¿™äº›å‚æ•°å¿…é¡»ä» sbatch ä¼ å…¥ï¼‰
echo "=================================================="
echo "  Received Parameters"
echo "=================================================="
echo "  ALGORITHM: ${ALGORITHM:-NOT_SET}"
echo "  NUM_PARAMS: ${NUM_PARAMS:-NOT_SET}"
echo "  INITIAL_CHECKPOINT: ${INITIAL_CHECKPOINT:-NOT_SET}"
echo "=================================================="
echo ""

if [ -z "$INITIAL_CHECKPOINT" ] || [ -z "$ALGORITHM" ] || [ -z "$NUM_PARAMS" ]; then
    echo "âŒ Error: Missing required parameters!"
    echo "  INITIAL_CHECKPOINT, ALGORITHM, and NUM_PARAMS must be set"
    exit 1
fi

# è®¾ç½® Python ç¯å¢ƒå˜é‡ï¼ˆå‡å°‘æ—¥å¿—å™ªéŸ³ï¼‰
export TRANSFORMERS_VERBOSITY=error
export TOKENIZERS_PARALLELISM=false
export PYTHONWARNINGS="ignore::FutureWarning,ignore::UserWarning,ignore::DeprecationWarning"

echo "ğŸš€ Starting Qwen VLM Service..."
echo ""
echo "Service Configuration:"
echo "  Base Model:    ${BASE_MODEL}"
echo "  Checkpoint:    ${INITIAL_CHECKPOINT}"
echo "  Algorithm:     ${ALGORITHM}"
echo "  Head Type:     ${HEAD_TYPE}"
echo "  Num Params:    ${NUM_PARAMS}"
echo "  Port:          ${PORT}"
echo "=================================================="
echo ""

# ä½¿ç”¨ qwen_server.pyï¼ˆæ”¯æŒåŠ¨æ€åˆ‡æ¢ checkpointï¼‰
${CONDA_PYTHON} ${SCRIPT_DIR}/qwen_server.py \
    --base_model "${BASE_MODEL}" \
    --lora_path "${INITIAL_CHECKPOINT}" \
    --algorithm "${ALGORITHM}" \
    --head_type "${HEAD_TYPE}" \
    --num_params ${NUM_PARAMS} \
    --port ${PORT} \
    --load_in_4bit

echo ""
echo "Qwen VLM service stopped."

